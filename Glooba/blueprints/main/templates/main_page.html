{% extends "layout.html" %}

{% block head %}
<head>
    <title>Empresas Comprometidas</title>
</head>
{% endblock %}

{% block content %}

<body>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            
            <!-- Columna izquierda -->
            <div class="col-span-1 sm:col-span-1 lg:col-span-1 hidden sm:block">
                <div class="bg-white ring-opacity-50 p-4 rounded-xl shadow-card space-y-4 mb-4">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-center">Glooba</h2>
                    <p class="text-sm font-normal mt-2 text-gray-500 text-center">
                        Ponemos a disposición información y geolocalización respecto a 
                        empresas que generan acciones sostenibles para una economía circular
                    </p>
                    <div class="flex justify-center mt-4">
                        <a href="https://www.instagram.com/gloobacl/" target="_blank" rel="noopener noreferrer">
                            <i class="bi bi-instagram h-6 w-6 text-sm font-medium mr-4 text-green-500 hover:text-green-600"></i>
                        </a>
                        <a href="https://www.linkedin.com/company/gloobapp?trk=public_profile_topcard-current-company" target="_blank" rel="noopener noreferrer">
                            <i class="bi bi-linkedin h-6 w-6 text-sm font-medium text-green-500 hover:text-green-600"></i>
                        </a>
                    </div>
                    <div class="flex items-center justify-center mt-4">
                        <a href="{{ url_for('main.index') }}" class="text-sm font-medium text-blue-500 hover:text-blue-600">
                            <i class="bi bi-info-circle-fill mr-1"></i>
                            Más información
                        </a>
                    </div>
                    
                </div>
               
                <div class="bg-white ring-opacity-50 p-4 rounded-xl shadow-card space-y-4">
                    <div class="flex items-center justify-between space-x-2">
                        <p class="text-base block font-black truncate">
                            Información de contacto
                        </p>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="relative self-center flex">
                            <a href="#" target="_blank" rel="noopener noreferrer">
                                <i class="bi bi-whatsapp h-6 w-6 text-sm font-medium text-green-500 hover:text-green-600"></i>
                            </a>
                        </div>
                        <a href="#" class="overflow-hidden hover:underline">
                            <p class="text-sm block font-light text-tertiary truncate">
                                +56 9 5332 1695
                            </p>
                        </a>
                    </div>

                    <div class="flex items-center space-x-4">
                        <div class="relative self-center flex">
                            <a href="#" target="_blank" rel="noopener noreferrer">
                                <i class="bi bi-envelope h-6 w-6 text-sm font-medium text-green-500 hover:text-green-600"></i>
                            </a>
                        </div>
                        <a href="#" class="overflow-hidden hover:underline">
                            <p class="text-sm block font-light text-tertiary truncate">
                                Gloobacl@gmail.com
                            </p>
                        </a>
                    </div>         
                </div>
            </div>

            <!-- Columna derecha -->
            <div class="col-span-1 sm:col-span-1 lg:col-span-2">

                    <div class="bg-white rounded-full mb-3 px-2">
                        <p id="user-address" class="text-sm sm:text-base overflow-hidden text-ellipsis whitespace-nowrap bg-gray-50 font-medium sm:font-normal">
                            <i class="bi bi-geo-alt text-green-500 mr-2"></i> 
                            <span id="location-text">Obteniendo tu ubicación...</span>
                        </p>       
                    </div>

                    <form method="GET" action="{{ url_for('main.empresas') }}">
                        <!-- Filtro de Búsqueda -->
                        <div class="mb-6 relative">
                            <input type="text" name="search" id="search" value="{{ search }}" placeholder="¿Qué buscas?" class="text-sm sm:text-base font-medium mt-2 py-2 pl-10 block w-full rounded-xl border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 "></i>
                        </div>
                    </form>

                        <!-- Botones de Explorar y Mapa -->
                        <div class="flex justify-center mx-4">
                            <div class="flex items-center bg-blue-100 rounded-full shadow-md w-full">
                                <button id="map-btn" class="flex-grow px-6 py-1 text-sm sm:text-base text-blue-600 font-semibold rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                    Mapa
                                </button>
                                <button id="list-btn" class="flex-grow px-6 py-1 text-white font-semibold bg-blue-500 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                    Lista
                                </button>
                            </div>
                        </div>
                    
                    <form method="GET" action="{{ url_for('main.empresas') }}">
                        <!-- Botones de filtros -->
                        <div class="flex justify-center py-4">
                            <div class="flex space-x-4 overflow-y-scroll no-scrollbar">
                                <!-- Botón Ordenar -->
                                <button class="flex items-center space-x-2 px-4 bg-gray-100 text-sm sm:text-base font-medium rounded-full hover:bg-gray-200 transition duration-200 whitespace-nowrap">
                                    <i class="bi bi-arrow-down-up"></i>
                                    <span>Ordenar</span>
                                    <i class="bi bi-caret-down-fill"></i>
                                </button>
                        
                                <!-- Botón Rubros -->
                                <button class="flex items-center space-x-2 px-4 bg-gray-100 text-sm sm:text-base font-medium rounded-full hover:bg-gray-200 transition duration-200 whitespace-nowrap">
                                    <i class="bi bi-shop-window"></i>
                                    <span>Rubros</span>
                                    <i class="bi bi-caret-down-fill"></i>
                                </button>
                        
                                <button class="flex items-center space-x-2 px-4 bg-gray-100 text-sm sm:text-base font-medium rounded-full hover:bg-gray-200 transition duration-200 whitespace-nowrap">
                                    <!-- Botón Certificaciones -->
                                    <i class="bi bi-award"></i>
                                    <span>Certificaciones</span>
                                    <i class="bi bi-caret-down-fill"></i>
                                </button>
                        
                                <!-- Botón Servicio a domicilio -->
                                <button class="flex items-center space-x-2 px-4 bg-gray-100 text-sm sm:text-base font-medium rounded-full hover:bg-gray-200 transition duration-200 whitespace-nowrap">
                                    <i class="bi bi-car-front"></i>
                                    <span>Servicio a domicilio</span>
                                </button>
                            </div>
                        </div>                        

                    </form>
                    
                <!-- Lista de empresas -->
                <div id="empresa-list" class="mb-4">
                    {% for empresa in empresas %}
                        <div class="space-y-6 hidden sm:block">
                            <a href="{{ url_for('main.perfil_empresa', empresa_id=empresa.id) }}" class="group block transform hover:scale-102 focus:scale-102 transition-all duration-200">
                                <div class="bg-white ring-opacity-50 p-3 sm:p-4 rounded-xl shadow-card group-hover:bg-gray-lightest group-hover:bg-opacity-50">
                                    <div class="flex items-center space-x-2 lg:space-x-6">
                                        
                                        <!-- Imagen -->
                                        <div class="w-20 sm:w-30 overflow-hidden-z rounded-md">
                                            <img src="{{ empresa.imagen_perfil }}" class="object-contain w-full h-full">
                                        </div>

                                        <!-- Información -->
                                        <div class="flex-1 min-w-0">
                                            <p class="text-base sm:text-lg font-extrabold text-tertiary break-words">
                                                {{ empresa.nombre }}
                                            </p>
                                            <p class="text-xs sm:text-sm block font-normal text-tertiary-light py-1">
                                                <span>{{ empresa.rubro }}</span>
                                            </p>

                                            <div class="line-clamp-3">
                                                <p class="text-xs sm:text-sm block font-normal text-tertiary-light">
                                                    <span class="break-words">
                                                        {{ empresa.descripcion }}
                                                    </span>
                                                </p>
                                            </div>

                                            <div class="flex items-center mt-2">
                                                <div class="flex items-center">
                                                    <i class="bi bi-bookmark-check text-green-500"></i>
                                                    <a href="{{ url_for('main.perfil_empresa', empresa_id=empresa.id) }}#ofertas" class="text-xs sm:text-sm block font-normal text-tertiary-light mx-1">
                                                        <span class="break-words">
                                                            Ofertas
                                                        </span>
                                                    </a>
                                                </div>
                                                <div class="flex items-center">
                                                    <i class="bi bi-pin-map text-green-500 ml-2"></i>
                                                    <a href="{{ url_for('main.perfil_empresa', empresa_id=empresa.id) }}#ubicaciones" class="text-xs sm:text-sm block font-normal text-tertiary-light mx-1">
                                                        <span class="break-words">
                                                            Ubicaciones
                                                        </span>
                                                    </a>
                                                </div>
                                                <!-- Sitio Web -->
                                                {% if empresa.sitio_web and empresa.sitio_web != "https://-" %}
                                                    <div class="flex items-center">
                                                        <i class="bi bi-globe text-green-500 ml-2"></i>
                                                        <a href="{{ empresa.sitio_web }}" class="text-xs sm:text-sm block font-normal text-tertiary-light mx-1" target="_blank">
                                                            <span class="break-words">
                                                                Sitio Web
                                                            </span>
                                                        </a>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>                            
                            </a>
                        </div>

                        <!-- Para pantallas pequeñas -->
                        <div class="relative bg-white rounded-xl shadow-md overflow-hidden mb-6 sm:hidden">
                            <div class="relative">
                                <img src="{{ empresa.imagen_fondo }}" alt="Imagen aleatoria" class="w-full h-24 object-cover filter border border-gray-200 rounded-lg">
                                
                                <!-- Etiqueta "Retiro o delivery"
                                <span class="absolute top-2 left-2 bg-black/70 text-white text-xs font-semibold px-2 py-0.5 rounded-full">
                                    Retiro o delivery 
                                </span>
                                -->

                                <!-- Icono de notificación -->
                                <button class="absolute top-2 right-2 bg-white w-8 h-8 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-200 transition">
                                    <i class="bi bi-bell text-sm text-gray-700"></i>
                                </button>

                                <!-- Logo del negocio (Más pequeño y mejor posicionado) -->
                                <div class="absolute -bottom-6 right-10 w-16 h-16 bg-white border border-gray-300 rounded-full shadow-lg flex items-center justify-center">
                                    <img src="{{ empresa.imagen_perfil }}" alt="Logo" class="w-16 h-16 rounded-full">
                                </div>
                            </div>

                            <!-- Contenido con borde redondeado -->
                            <div class="p-2 bg-white">
                                <!-- Información -->
                                <div class="flex-1 min-w-0">

                                    <p class="font-semibold text-gray-600 text-xs flex items-baseline gap-1">
                                        <span class="font-extrabold text-tertiary text-sm">{{ empresa.nombre }}</span> ({{ empresa.rubro }})
                                    </p>
                                    
                

                                    <div class="flex items-center mt-0.5">
                                        <div class="flex items-center">
                                            <i class="bi bi-bookmark-check text-green-500 text-xs"></i>
                                            <a href="{{ url_for('main.perfil_empresa', empresa_id=empresa.id) }}#ofertas" class="text-xs sm:text-sm block font-semibold text-tertiary-light mx-1">
                                                <span class="break-words">
                                                    Servicios/Productos
                                                </span>
                                            </a>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="bi bi-pin-map text-green-500 ml-2 text-xs"></i>
                                            <a href="{{ url_for('main.perfil_empresa', empresa_id=empresa.id) }}#ubicaciones" class="text-xs sm:text-sm block font-semibold text-tertiary-light mx-1">
                                                <span class="break-words">
                                                    Ubicaciones
                                                </span>
                                            </a>
                                        </div>
                                        <!-- Sitio Web -->
                                        {% if empresa.sitio_web and empresa.sitio_web != "https://-" %}
                                            <div class="flex items-center">
                                                <i class="bi bi-globe text-green-500 ml-2 text-xs"></i>
                                                <a href="{{ empresa.sitio_web }}" class="text-xs sm:text-sm block font-semibold text-tertiary-light mx-1" target="_blank">
                                                    <span class="break-words">
                                                        Sitio Web
                                                    </span>
                                                </a>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    {% if pagination.pages > 1 %}
                        <div class="mt-8 flex flex-wrap justify-center gap-2">
                            <!-- Botón Anterior -->
                            {% if pagination.has_prev %}
                            <a href="{{ url_for('main.empresas', page=pagination.prev_num, search=search, categoria=categoria_actual) }}"
                                class="px-3 py-1 text-sm font-medium rounded-xl text-white bg-green-500 hover:bg-green-600 transition">
                                «
                            </a>
                            {% endif %}

                            <!-- Páginas -->
                            {% for page_num in range(1, pagination.pages + 1) %}
                                {% if page_num == 1 or page_num == pagination.pages or (page_num >= pagination.page - 2 and page_num <= pagination.page + 2) %}
                                    <a href="{{ url_for('main.empresas', page=page_num, search=search, categoria=categoria_actual) }}"
                                        class="px-3 py-1 text-sm font-medium rounded-xl {% if page_num == pagination.page %} bg-green-600 text-white {% else %} bg-green-500 text-white hover:bg-green-600 {% endif %}">
                                        {{ page_num }}
                                    </a>
                                {% elif page_num == pagination.page - 3 or page_num == pagination.page + 3 %}
                                    <span class="px-3 py-1 text-sm font-medium text-gray-500">...</span>
                                {% endif %}
                            {% endfor %}

                            <!-- Botón Siguiente -->
                            {% if pagination.has_next %}
                            <a href="{{ url_for('main.empresas', page=pagination.next_num, search=search, categoria=categoria_actual) }}"
                                class="px-3 py-1 text-sm font-medium rounded-xl text-white bg-green-500 hover:bg-green-600 transition">
                                »
                            </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

                <!-- Mapa -->
                <div id="map-view" class="hidden">
                    <div id="map" style="width: 100%; height: 400px; border-radius: 10px; border: 1px solid #e2e2e2;"></div>
                </div>
            </div>
        </div>
    </div>
</body>

<!-- Scripts -->
<script>

// Función para cambiar entre vista de lista y mapa
document.getElementById('map-btn').addEventListener('click', function() {
    document.getElementById('empresa-list').classList.add('hidden');  // Ocultar la lista
    document.getElementById('map-view').classList.remove('hidden');   // Mostrar el mapa

    // Cambiar el estilo de los botones
    document.getElementById('list-btn').classList.remove('bg-blue-500', 'text-white');
    document.getElementById('list-btn').classList.add('text-blue-600', 'bg-blue-100');
    document.getElementById('map-btn').classList.remove('text-blue-600', 'bg-blue-100');
    document.getElementById('map-btn').classList.add('text-white', 'bg-blue-500');
});

document.getElementById('list-btn').addEventListener('click', function() {
    document.getElementById('empresa-list').classList.remove('hidden'); // Mostrar la lista
    document.getElementById('map-view').classList.add('hidden');        // Ocultar el mapa

    // Cambiar el estilo de los botones
    document.getElementById('map-btn').classList.remove('bg-blue-500', 'text-white');
    document.getElementById('map-btn').classList.add('text-blue-600', 'bg-blue-100');
    document.getElementById('list-btn').classList.remove('text-blue-600', 'bg-blue-100');
    document.getElementById('list-btn').classList.add('text-white', 'bg-blue-500');
});

// Opcional: Si deseas que el mapa se inicie con la vista de mapa por defecto, puedes descomentar lo siguiente:
// document.getElementById('map-btn').click(); 
    

// Variables globales del mapa
let map;
let markers = [];
let allUbicaciones = [];

function initMap() {
    console.log('Iniciando mapa...');
    const talca = { lat: -35.4264, lng: -71.6553 };
    
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 15,
        center: talca,
        styles: [
            {
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            },
            {
                featureType: "transit",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }
        ]
    });

    // Cargar ubicaciones iniciales
    cargarUbicacionesDesdeEmpresas();

    // Geolocalización
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Centrar mapa en la ubicación del usuario
                map.setCenter(pos);

                // Agregar marcador en la ubicación actual del usuario
                const userMarker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: "Ubicación Actual",
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: "blue",  // Color de fondo
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: "#ffffff",  // Color del borde
                        scale: 8  // Tamaño del círculo
                    }
                });

                // Opcional: Mostrar un InfoWindow con un mensaje
                const infoWindow = new google.maps.InfoWindow({
                    content: "<p>Ubicación actual del usuario</p>"
                });

                userMarker.addListener("click", function() {
                    infoWindow.open(map, userMarker);
                });
            },
            () => {
                console.log("Error: El servicio de geolocalización falló.");
            }
        );
    }
}

function cargarUbicacionesDesdeEmpresas() {
    fetch('/mapa/ubicaciones')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(ubicaciones => {
            console.log('Ubicaciones cargadas:', ubicaciones);
            allUbicaciones = ubicaciones;
            createMarkers(ubicaciones);

        })
        .catch(error => {
            console.error('Error cargando ubicaciones:', error);
        });
}

function createMarkers(ubicaciones) {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
    
    ubicaciones.forEach(ubicacion => {
        const lat = parseFloat(ubicacion.lat);
        const lng = parseFloat(ubicacion.lng);
        
        if (isNaN(lat) || isNaN(lng)) {
            console.error('Coordenadas inválidas para ubicación:', ubicacion);
            return;
        }

        const marker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            title: ubicacion.nombre,
            icon: ubicacion.es_propia ? null : {
                path: "M-1.547 12l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM0 0q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
                fillColor: "green",
                fillOpacity: 1,
                strokeWeight: 0,
                rotation: 0,
                scale: 2,
                anchor: new google.maps.Point(0, 20),
            }
        });

        const infowindow = new google.maps.InfoWindow({
            content: `
                <div class="p-4">
                    <h3 class="font-bold flex items-center">
                        ${ubicacion.nombre}
                        <a href="${ubicacion.sitio_web}" class="ml-1 text-blue-500 hover:underline" target="_blank">
                            <i class="bi bi-info-circle-fill"></i>
                        </a>
                    </h3>
                    <p>${ubicacion.direccion}</p>
                    <p>${ubicacion.ciudad}, ${ubicacion.region}</p>
                    <a href="${ubicacion.sitio_web}" class="flex items-center text-blue-500 hover:underline" target="_blank">
                        <i class="bi bi-globe mr-1"></i>Sitio web
                    </a>
                </div>
            `
        });

        marker.addListener('click', () => {
            infowindow.open(map, marker);
        });
        
        markers.push(marker);
    });
}

function obtenerUbicacion() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;

                // Llamada a Nominatim API para obtener dirección legible
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
                fetch(url)
                    .then((response) => response.json())
                    .then((data) => {
                        const direccion = data.display_name || "No se pudo obtener la dirección.";
                        document.getElementById("location-text").textContent = direccion;
                    })
                    .catch(() => {
                        document.getElementById("location-text").textContent = "Error al obtener la dirección.";
                    });
            },
            (error) => {
                // Manejo de errores en caso de que no se permita la geolocalización
                let mensajeError = "";
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        mensajeError = "Permiso denegado para acceder a tu ubicación.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        mensajeError = "Ubicación no disponible.";
                        break;
                    case error.TIMEOUT:
                        mensajeError = "Tiempo de espera agotado para obtener la ubicación.";
                        break;
                    default:
                        mensajeError = "Error desconocido.";
                }
                document.getElementById("location-text").textContent = mensajeError;
            }
        );
    } else {
        document.getElementById("location-text").textContent = "Geolocalización no soportada por tu navegador.";
    }
}

// Llamar a la función al cargar la página
obtenerUbicacion();

</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap" async defer></script>
{% endblock %}
